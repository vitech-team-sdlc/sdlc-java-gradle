buildPack: none
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
    label: jenkins-gradle
  env:
    - name: DOCKER_REGISTRY
      value: gcr.io
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: ""
    - name: REPORTS_BUCKET
      value: reports-tf-jx-concrete-lemur-0ba2a21ddb0a
    - name: REPORTS_BUCKET_HTTP
      value: https://storage.cloud.google.com
    - name: LARGE_TEST_FOLDER
      value: large-tests-reports
  pipelines:
    pullRequest:
      postBuild:
        steps:
#          - name: conventionalcommits-check
#            image: golang:1.15.2
#            command: go get github.com/talos-systems/conform && conform enforce > commit.check
          - name: conventionalcommits-check
            image: aevea/commitsar:latest
            command: $(commitsar > commit.check 2> commit.check.failed) || { echo 'commit check failed' ; exit 0; }
          - name: conventionalcommits-print
            command: cat commit.check.failed && cat commit.check
          - name: conventionalcommits-comment
            command: |
              if [ -f "commit.check.failed" ]; then
                  jx step pr comment -c "$(cat commit.check)"
                  exit 1;
              else
                 echo 'COMMIT CHECK PASSED!'
              fi
          #        steps:
#          - name: check-conventionalcommits
#            image: aevea/commitsar:latest
#            command: commitsar
#        steps:
#          - name: test
#            command: echo TEST
#        steps:
#          - name: store-file
#            command: echo "Source test" > test.txt
#          - name: test
#            command: jx step stash
#            args:
#              - -c large-tests
#              - --to-path $LARGE_TEST_FOLDER/$PULL_NUMBER/$BUILD_NUMBER
#              - -p *.txt
#              - --bucket-url gs://${REPORTS_BUCKET}
#          - name: print-url
#            command: jx step pr comment
#            args:
#              - -c "Report $REPORTS_BUCKET_HTTP/${REPORTS_BUCKET}/$LARGE_TEST_FOLDER/$PULL_NUMBER/$BUILD_NUMBER/index.html"
