buildPack: none
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
    label: jenkins-gradle
  env:
    - name: DOCKER_REGISTRY
      value: gcr.io
    - name: GOOGLE_APPLICATION_CREDENTIALS
  pipelines:
    pullRequest:
      setup:
        preSteps:
          - name: tartget-branch
            command: echo "$(git name-rev $PULL_PULL_SHA --name-only)" > target.branch
      pipeline:
        env:
          - name: DOCKER_REGISTRY
            value: gcr.io
          - name: GOOGLE_APPLICATION_CREDENTIALS
        stages:
          - agent:
              image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
            dir: /workspace/source
            name: Test
            steps:
              - name: sonar-file-enrich
                command: echo -e "\nsonar.host=$SONAR_HOST\nsonar.login=$SONAR_TOKEN\nsonar.pullrequest.branch=$(cat target.branch)\nsonar.pullrequest.base=$PULL_BASE_REF\nsonar.pullrequest.key=$PULL_NUMBER\nsonar.pullrequest.github.repository=$REPO_OWNER/$REPO_NAME\nsonar.projectKey=$REPO_OWNER:$REPO_NAME\nsonar.organization=$SONAR_ORG\nsonar.projectName=$REPO_NAME\nsonar.scm.provider=$SONAR_SCM\n$SONAR_OPT" >> sonar-project.properties && cat sonar-project.properties
                env:
                  - name: SONAR_TOKEN
                    valueFrom:
                      secretKeyRef:
                        name: sonar
                        key: sonar.login
                  - name: SONAR_ORG
                    valueFrom:
                      secretKeyRef:
                        name: sonar
                        key: sonar.organization
                  - name: SONAR_HOST
                    valueFrom:
                      secretKeyRef:
                        name: sonar
                        key: sonar.host.url
                  - name: SONAR_SCM
                    valueFrom:
                      secretKeyRef:
                        name: sonar
                        key: sonar.scm.provider
