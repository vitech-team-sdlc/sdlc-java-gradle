buildPack: none
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
    label: jenkins-gradle
  env:
    - name: DOCKER_REGISTRY
      value: gcr.io
    - name: GOOGLE_APPLICATION_CREDENTIALS
  pipelines:
    pullRequest:
      pipeline:
        env:
          - name: GIT_TOKEN
            valueFrom:
              secretKeyRef:
                name: jx-pipeline-git-github-github
                key: password
          - name: SONAR_TOKEN
            valueFrom:
              secretKeyRef:
                name: sonar
                key: sonar.login
          - name: SONAR_ORG
            valueFrom:
              secretKeyRef:
                name: sonar
                key: sonar.organization
          - name: SONAR_HOST
            valueFrom:
              secretKeyRef:
                name: sonar
                key: sonar.host.url
          - name: SONAR_SCM
            valueFrom:
              secretKeyRef:
                name: sonar
                key: sonar.scm.provider
        stages:
          - name: git
            agent:
              image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
            steps:
              - name: new-git-folder
                command: mkdir /workspace/source2
              - name: git-clone
                command: git clone $SOURCE_URL /workspace/source2
          - name: sonar-check
            dir: /workspace/source2
            agent:
              image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
            options:
              containerOptions:
                resources:
                  requests:
                    cpu: 0.4
                    memory: 512Mi
            steps:
              - name: get-pr-info
                dir: /workspace/source2
                image: 'gcr.io/jenkinsxio/jx-cli:3.0.232'
                command: jx gitops pr get --git-token=$GIT_TOKEN > pr.yaml
              - name: save-source-branch
                dir: /workspace/source2
                image: mikefarah/yq
                command: yq r pr.yaml Source > target.branch && rm pr.yaml
              - name: swith-branch
                dir: /workspace/source2
                command: git status && git fetch && git checkout $(cat target.branch)
              - name: gradle-buid
                dir: /workspace/source2
                image: gradle:6.3.0-jdk11
                command: gradle clean build --no-daemon
              - name: sonar
                dir: /workspace/source2
                image: sonarsource/sonar-scanner-cli:4.4
                command: cat sonar-project.properties && sonar-scanner
                args:
                  - "-Dsonar.host.url=${SONAR_HOST}"
                  - "-Dsonar.login=${SONAR_TOKEN}"
                  - "-Dsonar.pullrequest.branch=$(cat target.branch)"
                  - "-Dsonar.pullrequest.base=${PULL_BASE_REF}"
                  - "-Dsonar.pullrequest.key=${PULL_NUMBER}"
                  - "-Dsonar.pullrequest.github.repository=${REPO_OWNER}/${REPO_NAME}"
                  - "-Dsonar.projectKey=${REPO_OWNER}:${REPO_NAME}"
                  - "-Dsonar.organization=${SONAR_ORG}"
                  - "-Dsonar.projectName=${REPO_NAME}"
                  - "-Dsonar.scm.provider=${SONAR_SCM}"


