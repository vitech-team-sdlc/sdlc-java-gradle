buildPack: none
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
    label: jenkins-gradle
  env:
    - name: DOCKER_REGISTRY
      value: gcr.io
    - name: GOOGLE_APPLICATION_CREDENTIALS
  pipelines:
    pullRequest:
      postBuild:
        steps:
          - name: git-clone
            command: mkdir /workspace/source2 && git clone $SOURCE_URL /workspace/source2
          - name: gradle-buid
            dir: /workspace/source2
            command: gradle clean build --no-daemon
            options:
              resources:
                requests:
                  cpu: 0.5
                  memory: 512Mi
          - name: get-pr-info
            image: 'gcr.io/jenkinsxio/jx-cli:3.0.232'
            command: jx gitops pr get --git-token=$GIT_TOKEN > pr.yaml
            dir: /workspace/source2
            env:
              - name: GIT_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: jx-pipeline-git-github-github
                    key: password
          - name: save-source-branch
            image: mikefarah/yq
            dir: /workspace/source2
            command: yq r pr.yaml Source > target.branch
          - name: sonar-file-enrich
            command: echo -e "\nsonar.host.url=$SONAR_HOST\nsonar.login=$SONAR_TOKEN\nsonar.pullrequest.branch=$(cat target.branch)\nsonar.pullrequest.base=$PULL_BASE_REF\nsonar.pullrequest.key=$PULL_NUMBER\nsonar.pullrequest.github.repository=$REPO_OWNER/$REPO_NAME\nsonar.projectKey=$REPO_OWNER:$REPO_NAME\nsonar.organization=$SONAR_ORG\nsonar.projectName=$REPO_NAME\nsonar.scm.provider=$SONAR_SCM\n" >> sonar-project.properties
            dir: /workspace/source2
            env:
              - name: SONAR_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.login
              - name: SONAR_ORG
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.organization
              - name: SONAR_HOST
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.host.url
              - name: SONAR_SCM
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.scm.provider
          - name: sonar-result-file
            dir: /workspace/source2
            command: cat sonar-project.properties && rm pr.yaml
          - name: sonar
            dir: /workspace/source2
            image: sonarsource/sonar-scanner-cli:4.4
            command: git status && git fetch && git checkout $(cat target.branch) && sonar-scanner && git checkout master && rm target.branch

