buildPack: gradle
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - sh: export VERSION=$PREVIEW_VERSION && skaffold build -f skaffold.yaml
            name: container-build
            env:
              - value: gcr.io
                name: DOCKER_REGISTRY
      postBuild:
        steps:
          - sh: jx step post build --image $DOCKER_REGISTRY/$ORG/$APP_NAME:$PREVIEW_VERSION
            name: post-build
            env:
              - value: gcr.io
                name: DOCKER_REGISTRY
      promote:
        steps:
          - dir: ./charts/preview
            steps:
              - sh: make preview
                name: make-preview
                env:
                  - value: gcr.io
                    name: DOCKER_REGISTRY
              - sh: jx preview --app $APP_NAME --dir ../..
                name: jx-preview
                env:
                  - value: gcr.io
                    name: DOCKER_REGISTRY
 
