buildPack: gradle
pipelineConfig:
  agent:
    image: gradle5-java11
  pipelines:
    post:
      steps:
        - name: sonar-check-dir
          command: mkdir /workspace/source2
        - dir: /workspace/source2
          name: sonar-check
          steps:
            - name: git-clone
              command: git clone $SOURCE_URL /workspace/source2
            - name: get-pr-info
              image: 'gcr.io/jenkinsxio/jx-cli:3.0.232'
              command: jx gitops pr get --git-token=$GIT_TOKEN > pr.yaml
              env:
                - name: GIT_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: jx-pipeline-git-github-github
                      key: password
            - name: save-source-branch
              image: mikefarah/yq
              command: yq r pr.yaml Source > target.branch && rm pr.yaml
            - name: swith-branch
              command: git status && git fetch && git checkout $(cat target.branch)
            - name: gradle-buid
              image: gradle:6.3.0-jdk11
              command: gradle clean build --no-daemon
            - name: sonar
              image: sonarsource/sonar-scanner-cli:4.4
              command: cat sonar-project.properties && sonar-scanner
              args:
                - "-Dsonar.host.url=${SONAR_HOST}"
                - "-Dsonar.login=${SONAR_TOKEN}"
                - "-Dsonar.pullrequest.branch=$(cat target.branch)"
                - "-Dsonar.pullrequest.base=${PULL_BASE_REF}"
                - "-Dsonar.pullrequest.key=${PULL_NUMBER}"
                - "-Dsonar.pullrequest.github.repository=${REPO_OWNER}/${REPO_NAME}"
                - "-Dsonar.projectKey=${REPO_OWNER}:${REPO_NAME}"
                - "-Dsonar.organization=${SONAR_ORG}"
                - "-Dsonar.projectName=${REPO_NAME}"
                - "-Dsonar.scm.provider=${SONAR_SCM}"
              env:
                - name: SONAR_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: sonar
                      key: sonar.login
                - name: SONAR_ORG
                  valueFrom:
                    secretKeyRef:
                      name: sonar
                      key: sonar.organization
                - name: SONAR_HOST
                  valueFrom:
                    secretKeyRef:
                      name: sonar
                      key: sonar.host.url
                - name: SONAR_SCM
                  valueFrom:
                    secretKeyRef:
                      name: sonar
                      key: sonar.scm.provider
    release:
      postBuild:
        steps:
          - name: sonar-analysis
            image: sonarsource/sonar-scanner-cli:4.4
            command: sonar-scanner
            args:
              - "-Dsonar.host.url=${SONAR_HOST}"
              - "-Dsonar.login=${SONAR_TOKEN}"
              - "-Dsonar.projectKey=${REPO_OWNER}:${REPO_NAME}"
              - "-Dsonar.organization=${SONAR_ORG}"
              - "-Dsonar.projectName=${REPO_NAME}"
              - "-Dsonar.scm.provider=${SONAR_SCM}"
            env:
              - name: SONAR_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.login
              - name: SONAR_ORG
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.organization
              - name: SONAR_HOST
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.host.url
              - name: SONAR_SCM
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.scm.provider
