buildPack: gradle
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:2.1.138-757
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - sh: gradle clean bootJar
            name: gradle-build
          - sh: export VERSION=$PREVIEW_VERSION && skaffold build -f skaffold.yaml
            name: container-build
            env:
              - name: DOCKER_REGISTRY
                value: gcr.io
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: ''
      postBuild:
        replace: true
        steps:
          - sh: jx step post build --image $DOCKER_REGISTRY/$ORG/$APP_NAME:$PREVIEW_VERSION
            name: post-build
            env:
              - name: DOCKER_REGISTRY
                value: gcr.io
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: ''
      promote:
        replace: true
        steps:
          - dir: ./charts/preview
            steps:
              - sh: make preview
                name: make-preview
              - sh: jx preview --app $APP_NAME --dir ../..
                name: jx-preview

    release:
      build:
        replace: true
        steps:
          - sh: gradle clean bootJar
            name: gradle-build
          - sh: export VERSION=`cat VERSION` && skaffold build -f skaffold.yaml
            name: container-build
            env:
              - name: DOCKER_REGISTRY
                value: gcr.io
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: ''
          - sh: jx step post build --image $DOCKER_REGISTRY/$ORG/$APP_NAME:\$(cat VERSION)
            name: post-build
            env:
              - name: DOCKER_REGISTRY
                value: gcr.io
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: ''
      promote:
        replace: true
        steps:
          - dir: ./charts/REPLACE_ME_APP_NAME
            steps:
              - sh: jx step changelog --version v\$(cat ../../VERSION)
                name: changelog
                env:
                  - name: DOCKER_REGISTRY
                    value: gcr.io
                  - name: GOOGLE_APPLICATION_CREDENTIALS
                    value: ''
              - comment: release the helm chart
                sh: jx step helm release
                name: helm-release
              - comment: promote through all 'Auto' promotion Environments
                sh: jx promote -b --all-auto --timeout 1h --version \$(cat ../../VERSION)
                name: jx-promote
                env:
                  - name: DOCKER_REGISTRY
                    value: gcr.io
                  - name: GOOGLE_APPLICATION_CREDENTIALS
                    value: ''
