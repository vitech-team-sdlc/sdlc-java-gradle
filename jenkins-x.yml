buildPack: gradle
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:2.1.138-757
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - sh: gradle clean bootJar
            name: gradle-build

          #          - sh: export VERSION=$PREVIEW_VERSION && skaffold build -f skaffold.yaml
          #            name: container-build
          #            env:
          #              - valueFrom:
          #                  configMapKeyRef:
          #                    name: jenkins-x-docker-registry
          #                    key: docker.registry
          #              - name: GOOGLE_APPLICATION_CREDENTIALS
          #                value: ''

          - sh: /kaniko/executor $KANIKO_FLAGS --cache=true --cache-dir=/workspace --context=/workspace/source --dockerfile=/workspace/source/Dockerfile --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/$APP_NAME:$VERSION --cache-repo=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/cache
            name: container-build
            image: 'gcr.io/kaniko-project/executor:debug-v0.19.0'
            env:
              - name: DOCKER_REGISTRY
                value: gcr.io
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: ''
      promote:
        replace: true
        steps:
          - dir: ./charts/preview
            steps:
              - sh: make preview
                name: make-preview
                env:
                  - name: DOCKER_REGISTRY
                    value: gcr.io
              - sh: jx preview --app $APP_NAME --dir ../..
                name: jx-preview
                env:
                  - name: DOCKER_REGISTRY
                    value: gcr.io
