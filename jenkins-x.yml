buildPack: gradle
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
  env:
    - value: gcr.io
      name: DOCKER_REGISTRY
    - name: GIT_AUTHOR_EMAIL
      value: jenkins-x@googlegroups.com
    - name: GIT_AUTHOR_NAME
      value: jenkins-x-bot
    - name: GIT_COMMITTER_EMAIL
      value: jenkins-x@googlegroups.com
    - name: GIT_COMMITTER_NAME
      value: jenkins-x-bot
    - name: XDG_CONFIG_HOME
      value: /home/jenkins
  pipelines:
    pullRequest:
      setup:
        preSteps:
          - name: save-version
            command: git name-rev $PULL_PULL_SHA --name-only >> target.branch
      postBuild:
        steps:
          - name: sonar-file-enrich
            loop:
              variable: SONAR_OPT
              values:
                - sonar.host=$SONAR_HOST
            command: echo -e "\nsonar.host=$SONAR_HOST\nsonar.login=$SONAR_TOKEN\nsonar.pullrequest.branch=$(cat target.branch)\nsonar.pullrequest.base=$PULL_BASE_REF\nsonar.pullrequest.key=$PULL_NUMBER\nsonar.pullrequest.github.repository=$REPO_OWNER/$REPO_NAME\nsonar.projectKey=$REPO_OWNER:$REPO_NAME\nsonar.organization=$SONAR_ORG\nsonar.projectName=$REPO_NAME\nsonar.scm.provider=$SONAR_SCM\n$SONAR_OPT" >> sonar-project.properties
            env:
              - name: SONAR_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.login
              - name: SONAR_ORG
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.organization
              - name: SONAR_HOST
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.host.url
              - name: SONAR_SCM
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.scm.provider
          - name: sonar-result-file
            command: cat sonar-project.properties
          - name: sonar
            image: sonarsource/sonar-scanner-cli:4.4
            command: sonar-scanner

