buildPack: gradle
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-gradle5-java11:latest
  env:
    - value: gcr.io
      name: DOCKER_REGISTRY
    - name: GIT_AUTHOR_EMAIL
      value: jenkins-x@googlegroups.com
    - name: GIT_AUTHOR_NAME
      value: jenkins-x-bot
    - name: GIT_COMMITTER_EMAIL
      value: jenkins-x@googlegroups.com
    - name: GIT_COMMITTER_NAME
      value: jenkins-x-bot
    - name: XDG_CONFIG_HOME
      value: /home/jenkins
  pipelines:
    pullRequest:
      postBuild:
        steps:
          - name: sonar
            image: sonarsource/sonar-scanner-cli
            command: sonar-scanner
            args:
              - -Dsonar.host=${SONAR_HOST}
              - -Dsonar.login=${SONAR_TOKEN}

              - -Dsonar.pullrequest.branch=$(git name-rev ${PULL_PULL_SHA} --name-only)
              - -Dssonar.pullrequest.base=${PULL_BASE_REF}
              - -Dsonar.pullrequest.key=${PULL_NUMBER}
              - -Dsonar.pullrequest.github.repository=${REPO_OWNER}/${REPO_NAME}

              - -Dsonar.projectKey=${REPO_OWNER}:${REPO_NAME}
              - -Dsonar.organization=${SONAR_ORG}
              - -Dsonar.projectName=${REPO_NAME}
              - -Dsonar.scm.provider=${SONAR_SCM}
            env:
              - name: SONAR_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.login
              - name: SONAR_ORG
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.organization
              - name: SONAR_HOST
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.host
              - name: SONAR_SCM
                valueFrom:
                  secretKeyRef:
                    name: sonar
                    key: sonar.scm.provider

